---
title: "Assignment7"
author: "Borzyk"
date: "2025-12-04"
output: html_document
---
Please write an R function which implements a forward feature selection approach for a multiple linear regression model. The function should have two options for the performance measure: (i) the Akaike information criteria (AIC) and (ii) a leave-many-out cross-validation strategy which uses four folds.

Test the function by predicting the winter wheat yield on the basis of any other yield included in your crop dataset.

Write an Rmd file with html output which tests the functionality of the above functions and graphically shows the performance of the individual models computed during the feature selection with an increasing order of variables used for the prediction. The Rmd file should also print the performance and the variables used within the final model in the end.


Zun채chst Daten einladen und f체r weiteres vorgehen anpassen
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
```{r}
Feldfruechte <- readRDS("C:/Users/Tobias/Documents/GEOmaster/Data_Analysis/data/cp_clean.rds")
library("caret")

Feldfruechte_neu <- na.omit(Feldfruechte[, c("Winter_wheat", "Rye", "Winter_barley", "Spring_barley", "Oat","Triticale","Potatos","Suggar_beets","Rapeseed","Silage_maize")])


y1 <- Feldfruechte_neu$Winter_wheat
x1 <- Feldfruechte_neu$Rye
x2 <- Feldfruechte_neu$Winter_barley
x3 <- Feldfruechte_neu$Spring_barley
x4 <- Feldfruechte_neu$Oat
x5 <- Feldfruechte_neu$Triticale
x6 <- Feldfruechte_neu$Potatos
x7 <- Feldfruechte_neu$Suggar_beets
x8 <- Feldfruechte_neu$Rapeseed
x9 <- Feldfruechte_neu$Silage_maize

df_simpl <- data.frame(dep  = y1,
                       x1 = x1,
                       x2 = x2,
                       x3 = x3,
                       x4 = x4,
                       x5 = x5,
                       x6 = x6,
                       x7 = x7,
                       x8 = x8,
                       x9 = x9
                       )
variablen <- c("x1", "x2", "x3", "x4", "x5", "x6", "x7", "x8", "x9")



```
Loop f체r forward_feature_selection
```{r}
forward_fs <- function(df_simpl, dep, vars, mode = c("AIC","CV4")) {
  mode <- match.arg(mode)
  
  selected <- c()
  remaining <- vars
  performance <- c()
  models <- list()
  
  while (length(remaining) > 0) {
    
    results <- data.frame(var = remaining, score = NA)
    
    for (v in remaining) {
      form <- as.formula(
        paste(dep, "~", paste(c(selected, v), collapse = "+"))
      )
      
      if (mode == "AIC") {
        fit <- lm(form, data = df_simpl)
        score <- AIC(fit)
      }
      
      if (mode == "CV4") {
        ctrl <- trainControl(method = "cv", number = 4)
        fit <- train(form, data = df_simpl, method = "lm", trControl = ctrl)
        score <- fit$results$RMSE
      }
      
      results$score[results$var == v] <- score
    }
    
    best <- results$var[which.min(results$score)]
    best_score <- min(results$score)
    
    if (length(performance) > 0) {
      if (best_score > tail(performance, 1)) {
        cat("Stopping because performance worsened.\n")
        break
      }
    }
    
    selected <- c(selected, best)
    remaining <- setdiff(remaining, best)
    performance <- c(performance, best_score)
    models[[length(models) + 1]] <- selected
    
    cat("Selected:", best, " | Score:", round(best_score,4), "\n")
  }
  
  return(list(selected = selected,
              performance = performance,
              models = models))
}
```

Plots f체r AIC Forward selection und 4-fold CV Forward Selection
```{r}
vars <- c("x1","x2","x3","x4","x5","x6","x7","x8","x9")

# AIC Forward Selection
res_AIC <- forward_fs(df_simpl, dep = "dep", vars = vars, mode = "AIC")

# 4-fold CV Forward Selection
res_CV <- forward_fs(df_simpl, dep = "dep", vars = vars, mode = "CV4")


plot(res_AIC$performance, type="b", 
     xlab="Anzahl der variablen", ylab="AIC", main="AIC Forward Selection")

plot(res_CV$performance, type="b", 
     xlab="Anzahl der variablen", ylab="CV RMSE", main="4-fold CV Forward Selection")

cat("Cross Validation selected:", paste(res_CV$selected, collapse = ", "), "\n")
cat("Final CV performance:", tail(res_CV$performance, 1), "\n")

cat("AIC selected:", paste(res_AIC$selected, collapse = ", "), "\n")
cat("Final AIC:", tail(res_AIC$performance, 1), "\n")
```

